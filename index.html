<script>
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRE9EZ7Sjxo2rc7MskMriOvjtTYyeE_l-hMqvo2I9LFjPvjCa8CEjCFE3kXV7Xzjc4triXQbHRfoErp/pub?output=csv&gid=4700759&single=true";

  const REFRESH_MS = 10000;

  function parseCSV(text) {
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i], next = text[i + 1];
      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }
      if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes) {
        if (cur.length || row.length) row.push(cur);
        cur = "";
        if (row.length) rows.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows.map(r => r.map(x => (x ?? "").trim()));
  }

  function toNumber(x) {
    const n = Number(String(x).trim());
    return Number.isFinite(n) ? n : null;
  }

  function findHeaderRow(rows) {
    // Scan first 5 rows for a row that contains "names" and "total"
    const maxScan = Math.min(rows.length, 5);
    for (let ri = 0; ri < maxScan; ri++) {
      const r = rows[ri].map(c => c.toLowerCase());
      const hasName = r.some(c => c.includes("name"));
      const hasTotal = r.some(c => c.includes("total"));
      if (hasName && hasTotal) return ri;
    }
    return 0; // fallback
  }

  function setStatus(msg) {
    let el = document.getElementById("status");
    if (!el) {
      el = document.createElement("div");
      el.id = "status";
      el.style.color = "#b00";
      el.style.margin = "12px 0";
      document.body.insertBefore(el, document.getElementById("tbl"));
    }
    el.textContent = msg || "";
  }

  async function load() {
    try {
      const url = CSV_URL + "&_t=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`CSV fetch failed: ${res.status} ${res.statusText}`);

      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) { setStatus("No data in CSV."); return; }

      const headerRowIndex = findHeaderRow(rows);
      const header = rows[headerRowIndex].map(h => h.toLowerCase());

      let iName = header.findIndex(h => h.includes("name"));
      let iTotal = header.findIndex(h => h.includes("total"));
      let iThrough = header.findIndex(h => h.includes("through"));

      // Fallback if not found (A=name, B=total, M=through)
      if (iName < 0) iName = 0;
      if (iTotal < 0) iTotal = 1;
      if (iThrough < 0) iThrough = 12;

      // Data starts after the header row we found
      const dataRows = rows.slice(headerRowIndex + 1);

      // If "Through" header is in L but values are in M, auto-shift
      // Detect by checking first non-empty player row
      const first = dataRows.find(r => (r[iName] ?? "").trim() !== "");
      if (first) {
        const throughHere = toNumber(first[iThrough]);
        const throughNext = toNumber(first[iThrough + 1]);
        if (throughHere === null && throughNext !== null) iThrough = iThrough + 1;
      }

      const data = dataRows
        .map(r => ({
          name: (r[iName] ?? "").trim(),
          total: toNumber(r[iTotal]),
          through: toNumber(r[iThrough]),
        }))
        .filter(d => d.name && d.name.toLowerCase() !== "names"); // skip label row

      if (!data.length) {
        setStatus("Loaded CSV, but no player rows parsed. (Sheet header/layout mismatch.)");
      } else {
        setStatus("");
      }

      data.sort((a,b) => (a.total ?? 9999) - (b.total ?? 9999));

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      for (const d of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.name}</td>
          <td class="right">${d.total ?? ""}</td>
          <td class="right">${d.through ?? ""}</td>
        `;
        tbody.appendChild(tr);
      }
    } catch (e) {
      setStatus(String(e));
    }
  }

  load();
  setInterval(load, REFRESH_MS);
</script>
