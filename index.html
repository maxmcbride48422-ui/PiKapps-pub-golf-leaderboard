<script>
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRE9EZ7Sjxo2rc7MskMriOvjtTYyeE_l-hMqvo2I9LFjPvjCa8CEjCFE3kXV7Xzjc4triXQbHRfoErp/pub?output=csv&gid=4700759&single=true";

  const REFRESH_MS = 10000;

  function parseCSV(text) {
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i], next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }

      if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes) {
        if (cur.length || row.length) row.push(cur);
        cur = "";
        if (row.length) rows.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows.map(r => r.map(x => (x ?? "").trim()));
  }

  function toNumber(x) {
    const n = Number(String(x).trim());
    return Number.isFinite(n) ? n : null;
  }

  function setStatus(msg) {
    let el = document.getElementById("status");
    if (!el) {
      el = document.createElement("div");
      el.id = "status";
      el.style.color = "#b00";
      el.style.margin = "12px 0";
      document.body.insertBefore(el, document.getElementById("tbl"));
    }
    el.textContent = msg || "";
  }

  async function load() {
    try {
      const url = CSV_URL + "&_t=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`CSV fetch failed: ${res.status} ${res.statusText}`);

      const text = await res.text();
      const rows = parseCSV(text);

      console.log("CSV rows:", rows.length);
      console.log("Header preview:", rows[0]);

      if (!rows.length) { setStatus("No data found in CSV."); return; }

      // Try header-based mapping first
      const header = (rows[0] || []).map(h => h.toLowerCase());
      let iName = header.findIndex(h => h.includes("name"));
      let iTotal = header.findIndex(h => h.includes("total"));
      let iThrough = header.findIndex(h => h.includes("through"));

      // Fallback if headers aren't detected:
      // A=name (0), B=total (1), L=through (11)
      if (iName < 0 || iTotal < 0 || iThrough < 0) {
        console.warn("Header match failed, using fallback columns A,B,L");
        iName = 0;
        iTotal = 1;
        iThrough = 11;
      }

      const data = rows.slice(1)
        .map(r => ({
          name: r[iName]?.trim(),
          total: toNumber(r[iTotal]),
          through: toNumber(r[iThrough]),
        }))
        .filter(d => d.name);

      console.log("Parsed players:", data);

      if (!data.length) {
        setStatus("Loaded CSV, but no player rows were parsed. Check column positions / headers.");
      } else {
        setStatus("");
      }

      data.sort((a,b) => (a.total ?? 9999) - (b.total ?? 9999));

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      for (const d of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.name}</td>
          <td class="right">${d.total ?? ""}</td>
          <td class="right">${d.through ?? ""}</td>
        `;
        tbody.appendChild(tr);
      }
    } catch (e) {
      console.error(e);
      setStatus(String(e));
    }
  }

  load();
  setInterval(load, REFRESH_MS);
</script>

